#include <SFML/Graphics.hpp>
#include <SFML/Graphics/Rect.hpp>
#include <SFML/Config.hpp>
#include <iostream>
#include <optional>
#include <array>
#include <cstdlib>
#include "Personaje.h"
#include "Biblioteca.h"
#include "MapaPrincipal.h"
#include "TileMap.h"
#include "BancoPreguntas.h"

// Si usas un banco global:
extern BancoPreguntas banco;

constexpr float RADIO_INTERACCION_RULETA = 100.0f;

static bool intersecta(const sf::FloatRect& A, const sf::FloatRect& B) {
#if SFML_VERSION_MAJOR >= 3
    const float ax1 = A.position.x;
    const float ay1 = A.position.y;
    const float ax2 = ax1 + A.size.x;
    const float ay2 = ay1 + A.size.y;

    const float bx1 = B.position.x;
    const float by1 = B.position.y;
    const float bx2 = bx1 + B.size.x;
    const float by2 = by1 + B.size.y;

    return (ax1 < bx2) && (ax2 > bx1) && (ay1 < by2) && (ay2 > by1);
#else
    // SFML 2.x
    return (A.left < B.left + B.width) &&
           (A.left + A.width > B.left) &&
           (A.top  < B.top  + B.height) &&
           (A.top  + A.height > B.top);
#endif
}

Biblioteca::Biblioteca(GestorEstados* gestor, sf::RenderWindow& window, Personaje& personaje)
    : Estado(gestor, personaje)
    , m_window(window)
    , m_personaje(personaje)
    , m_ancho(120)
    , m_alto(67)
    , m_tilemapBase()
    , m_arteJuego(window)
    , m_minijuegoActivo(false)
{
    // Ruleta
    if (m_ruleta.cargar("assets/Spinwheel/spinwheel1.png")) {
        m_ruleta.setPosition(960.0f, 340.0f);
        std::cout << "‚úì Ruleta cargada\n";
    } else {
        std::cerr << "‚úó ERROR: No se pudo cargar la ruleta\n";
    }

    // √Årea de salida (roja transl√∫cida)
    m_areaSalida.setSize(sf::Vector2f(62, 32));
    m_areaSalida.setPosition({960, 1020});
    m_areaSalida.setFillColor(sf::Color(255, 0, 0, 128));

    // 4 puertas: 0 ruleta, 1 minijuego, 2 teletransporte, 3 mensaje
    const sf::Vector2f tam = m_areaSalida.getSize();
    const std::array<sf::Vector2f,4> posiciones = {
        sf::Vector2f{860.f,  940.f},   // 0: ruleta
        sf::Vector2f{1060.f, 940.f},   // 1: minijuego
        sf::Vector2f{860.f,  880.f},   // 2: teletransporte
        sf::Vector2f{1060.f, 880.f}    // 3: mensaje
    };
    const std::array<sf::Color,4> colores = {
        sf::Color(0, 128, 255, 128),   // azul
        sf::Color(0, 200, 0, 128),     // verde
        sf::Color(200, 150, 0, 128),   // naranja
        sf::Color(160, 0, 160, 128)    // morado
    };
    for (std::size_t i = 0; i < puertas.size(); ++i) {
        puertas[i].setSize(tam);
        puertas[i].setPosition(posiciones[i]);
        puertas[i].setFillColor(colores[i]);
    }

    // Posici√≥n inicial del player
    m_personaje.setPosition(962, 950);

    // Datos del mapa
    inicializarDatosMapa();
}

Biblioteca::~Biblioteca() {}

void Biblioteca::inicializarDatosMapa() {
    m_tilesBase = {
          0,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  2,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         19, 20, 20, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 20, 20, 20, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 20, 20, 20, 20, 20, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 20, 20, 21,
         19, 20, 50, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 69, 20, 20, 20, 20, 50, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 69, 20, 20, 20, 50, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 69, 20, 20, 20, 20, 20, 20, 50, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 69, 20, 20, 20, 50, 76, 77, 78, 79, 80, 76, 77, 78, 79, 80, 69, 20, 21,
         19, 20, 50, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 69, 20, 20, 20, 20, 50, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 69, 20, 20, 20, 50, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 69, 13, 14, 15, 16, 17, 18, 50, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 69, 20, 20, 20, 50, 95, 96, 97, 98, 99, 95, 96, 97, 98, 99, 69, 20, 21,
         19, 20, 50,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118, 69, 20, 20, 20, 20, 50,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118, 69, 20, 20, 20, 50,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118, 69, 32, 33, 34, 35, 36, 37, 50,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118,114,115,116,117,118, 69, 20, 20, 20, 50,114,115,116,117,118,114,115,116,117,118, 69, 20, 21,
         19, 20, 50,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137, 69, 20, 20, 20, 20, 50,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137, 69, 20, 20, 20, 50,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137, 69, 51, 52, 53, 54, 55, 56, 50,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137,133,134,135,136,137, 69, 20, 20, 20, 50,133,134,135,136,137,133,134,135,136,137, 69, 20, 21,
         19, 20, 50,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156, 69, 20, 20, 20, 20, 50,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156, 69, 20, 20, 20, 50,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156, 69, 70, 71, 72, 73, 74, 75, 50,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156,152,153,154,155,156, 69, 20, 20, 20, 50,152,153,154,155,156,152,153,154,155,156, 69, 20, 21,
         19, 20, 50,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175, 69, 20, 20, 20, 20, 50,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175, 69, 20, 20, 20, 50,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175, 69, 89, 90, 91, 92, 93, 94, 50,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175,171,172,173,174,175, 69, 20, 20, 20, 50,171,172,173,174,175,171,172,173,174,175, 69, 20, 21,
         19, 20, 50,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194, 69, 20, 20, 20, 20, 50,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194, 69, 20, 20, 20, 50,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194, 69, 20, 20, 20, 20, 20, 20, 50,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194,190,191,192,193,194, 69, 20, 20, 20, 50,190,191,192,193,194,190,191,192,193,194, 69, 20, 21,
         19, 20, 50,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,131, 31, 31, 31, 31,132,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,131, 31, 31, 31,132,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,131, 31, 31, 31, 31, 31, 31,132,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,209,210,211,212,213,131, 31, 31, 31,132,209,210,211,212,213,209,210,211,212,213, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 20, 12, 12, 12, 12, 12, 12, 12,113,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,112, 12, 12, 12, 12, 12, 12, 12, 20, 20, 21,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         19, 20, 20, 31, 31, 31, 31, 31, 31, 31,132,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,  3,  4,  4,  4,  4,  4,  4,  5,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,  3,  4,  4,  4,  4,  4,  4,  5,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,131, 31, 31, 31, 31, 31, 31, 31, 20, 20, 21,
         19, 20, 50, 81, 82, 83, 84,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 81, 82, 83, 84, 69, 20, 21,
         19, 20, 50,100,101,102,103,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,100,101,102,103, 69, 20, 21,
         19, 20, 50,119,120,121,122,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,119,120,121,122, 69, 20, 21,
         19, 20, 50,138,139,140,141,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,138,139,140,141, 69, 20, 21,
         19, 20, 50,157,158,159,160,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,157,158,159,160, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 20, 12, 12, 12, 12, 12, 12, 12,113,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 22, 23, 23, 23, 23, 23, 23, 24,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,112, 12, 12, 12, 12, 12, 12, 12, 20, 20, 21,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 22, 23, 23, 23, 23, 23, 23, 24,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127, 22, 23, 23, 23, 23, 23, 23, 24,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         19, 20, 20, 31, 31, 31, 31, 31, 31, 31,132,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146, 22, 23, 23, 23, 23, 23, 23, 24,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,131, 31, 31, 31, 31, 31, 31, 31, 20, 20, 21,
         19, 20, 50, 81, 82, 83, 84,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,  6,  7,  8, 22, 23, 23, 23, 23, 23, 23, 24,  9, 10, 11,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 81, 82, 83, 84, 69, 20, 21,
         19, 20, 50,100,101,102,103,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 25, 26, 27, 22, 23, 23, 23, 23, 23, 23, 24, 28, 29, 30,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,100,101,102,103, 69, 20, 21,
         19, 20, 50,119,120,121,122,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 44, 45, 46, 22, 23, 23, 23, 23, 23, 23, 24, 47, 48, 49,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,119,120,121,122, 69, 20, 21,
         19, 20, 50,138,139,140,141,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 63, 64, 65, 22, 23, 23, 23, 23, 23, 23, 24, 66, 67, 68,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,138,139,140,141, 69, 20, 21,
         19, 20, 50,157,158,159,160,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 41, 42, 42, 42, 42, 42, 42, 43,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165, 41, 42, 42, 42, 42, 42, 42, 43,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,157,158,159,160, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 60, 61, 61, 61, 61, 61, 61, 62,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108, 60, 61, 61, 61, 61, 61, 61, 62,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 50,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128,129,130,127,128, 69, 20, 21,
         19, 20, 50,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147,148,149,146,147, 69, 20, 21,
         19, 20, 50,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166,167,168,165,166, 69, 20, 21,
         19, 20, 50,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109,110,111,108,109, 69, 20, 21,
         19, 20, 20, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12,113, 57, 57, 57, 57,112, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 20, 20, 21,
         19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 50, 57, 57, 57, 57, 69, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21,
         38, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 40, 57, 57, 57, 57, 38, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 40,
    };

    m_tilesValidos = {
        108, 109, 110, 111, 127, 128, 129, 130, 146, 147, 148, 149, 165, 166, 167, 168
    };

    if (m_tilesBase.size() != m_ancho * m_alto) {
        std::cerr << "‚ùå ERROR: m_tilesBase tiene tama√±o incorrecto. Esperado: "
                  << m_ancho * m_alto << ", Obtenido: " << m_tilesBase.size() << std::endl;
    }
}

void Biblioteca::ejecutarMapa() {

    // Verificar que los vectores tengan datos
    if (m_tilesBase.empty()) {
        std::cerr << "‚ùå ERROR: m_tilesBase est√° vac√≠o" << std::endl;
        return;
    }

    if (!m_tilemapBase.load("assets/Tilesets/libreria.png", sf::Vector2u(16, 16),
                          m_tilesBase, m_ancho, m_alto)) {
        std::cerr << "‚ùå ERROR cargando el tilemap base" << std::endl;
    }
}

void Biblioteca::manejarEventos(sf::RenderWindow& window) {
    while (auto event = m_window.pollEvent()) {
        const sf::Event& ev = *event; // desreferencia el optional

        // --- cierre de ventana ---
        if (ev.is<sf::Event::Closed>()) {
            m_window.close();
            return;
        }

        // --- eventos teclado ---
        if (const auto* key = ev.getIf<sf::Event::KeyPressed>()) {
            if (key->code == sf::Keyboard::Key::Escape)
                m_window.close();

            if (key->code == sf::Keyboard::Key::Space)
                interaccionRuleta();

            if (key->code == sf::Keyboard::Key::P)
                iniciarMinijuegoPokePreguntas();
        }

        // --- eventos mouse ---
        if (const auto* mouse = ev.getIf<sf::Event::MouseButtonPressed>()) {
            if (mouse->button == sf::Mouse::Button::Left) {
                if (m_minijuegoActivo) {
                    sf::Vector2f pos(mouse->position.x, mouse->position.y);
                    m_arteJuego.manejarEventos(ev); // ‚úÖ deja que MinijuegoArte gestione clicks
                }
            }
        }

        // --- reenviar al minijuego si est√° activo ---
        if (m_minijuegoActivo)
            m_arteJuego.manejarEventos(ev);
    }
}

void Biblioteca::actualizar() {
    float deltaTime = m_clock.restart().asSeconds();

    if (m_minijuegoActivo) {
        m_arteJuego.actualizar(deltaTime);
        // Si el minijuego tiene API para saber si termin√≥:
        if (m_arteJuego.terminado()) {
            m_minijuegoActivo = false;
        }
        return; // pausa el resto mientras el minijuego est√° arriba
    }

    m_ruleta.actualizar(deltaTime);
    m_personaje.actualizar(m_tilesBase, m_ancho, m_alto);
    m_personaje.setTilesValidos(m_tilesValidos);

    // Salida general
    const sf::FloatRect personajeBounds = m_personaje.obtenerHitbox();
    const sf::FloatRect triggerSalida   = m_areaSalida.getGlobalBounds();

    // Disparadores por ‚Äúpuerta‚Äù (edge-trigger)
    for (std::size_t i = 0; i < puertas.size(); ++i) {
        const sf::FloatRect area = puertas[i].getGlobalBounds();
        const bool ahora = intersecta(personajeBounds, area);

        if (ahora && !colisionandoAntes[i]) {
            switch (i) {
                case 0: // ruleta
                    interaccionRuleta();
                    std::cout << "üé∞ Activaste la ruleta (√°rea 0)\n";
                    break;
                case 1: // minijuego
                    if (!m_minijuegoActivo) {
                        iniciarMinijuegoPokePreguntas();
                        std::cout << "üéÆ Minijuego iniciado (√°rea 1)\n";
                    }
                    break;
                case 2: // teletransporte
                    m_personaje.setPosition(960.f, 860.f);
                    std::cout << "üåÄ Teletransporte (√°rea 2)\n";
                    break;
                case 3: // mensaje
                    std::cout << "üí° Consejo: ac√©rcate a la ruleta o presiona P para jugar.\n";
                    break;
            }
        }
        colisionandoAntes[i] = ahora;
    }

    // Salir de la biblioteca por √°rea roja
    if (intersecta(personajeBounds, triggerSalida)) {
        std::cout << "üö™ Saliendo de la biblioteca.\n";
        gestor->sacarEstado();
        m_personaje.setPosition(915, 300);
    }
}

void Biblioteca::dibujar(sf::RenderWindow& window) {
    if (m_minijuegoActivo) {
        m_arteJuego.dibujar();
        return;
    }

    window.draw(m_tilemapBase);
    window.draw(m_areaSalida);
    for (const auto& a : m_areasExtra) window.draw(a);
    m_personaje.dibujar(window);
    m_ruleta.dibujar(window);

    // Debug: puertas
    for (const auto& p : puertas) window.draw(p);
}

void Biblioteca::interaccionRuleta() {
    // Solo si el player est√° cerca
    const sf::Vector2f posRuleta     = m_ruleta.getPosition();
    const sf::Vector2f posPersonaje  = m_personaje.getPosition();
    const float dx = posRuleta.x - posPersonaje.x;
    const float dy = posRuleta.y - posPersonaje.y;
    const float dist2 = dx*dx + dy*dy;

    if (dist2 < (RADIO_INTERACCION_RULETA * RADIO_INTERACCION_RULETA)) {
        float velocidadInicial = 1000.0f + (std::rand() % 800);
        m_ruleta.iniciarGiro(velocidadInicial);
        std::cout << "¬°Ruleta girando!\n";
    } else {
        std::cout << "Ac√©rcate a la ruleta (radio " << RADIO_INTERACCION_RULETA << "px).\n";
    }
}

void Biblioteca::iniciarMinijuegoPokePreguntas() {
    m_minijuegoActivo = true;
    m_arteJuego.iniciarCombate(); // dentro de MinijuegoArte configura y hace reset
    std::cout << "¬°Pok√©mon salvaje apareci√≥! Minijuego iniciado.\n";
}
